# 后端部署到阿里云 — 为什么不用再经 Railway、如何降低延迟

## 为什么延迟高？

当前请求路径是：

```
用户（国内） → Vercel（前端） → Railway（后端，海外） → 阿里云 RDS / 阿里云 OSS
```

- **数据库**和 **OSS** 已经在阿里云（同地域），访问很快。
- **后端 API 还在 Railway**（通常在美国等海外节点），所以：
  - 每次请求都要：用户/Vercel → 海外 Railway → 再回国内阿里云；
  - 图片上传要：浏览器 → Vercel → Railway → 阿里云 OSS，多绕一圈，延迟和超时都会变差。

所以：**用了阿里云 RDS/OSS 后，如果后端还在 Railway，就一定会多一段跨境/跨地域，延迟高是必然的。**

---

## 目标架构（推荐）

把 **NestJS 后端** 也部署到 **阿里云**，和 RDS、OSS 同地域：

```
用户 → Vercel（或阿里云前端） → 阿里云上的后端 → 阿里云 RDS + 阿里云 OSS（同地域，延迟低）
```

这样：
- 前端到后端：若用户在国内、后端在阿里云国内，延迟会明显下降。
- 后端到 RDS/OSS：同地域内网或同区公网，延迟和稳定性都好很多，上传图片也不容易超时。

**不需要再经 Railway**：只要把前端的 `NEXT_PUBLIC_API_BASE` 指到阿里云上的后端地址即可，Railway 可以停用或只做备份。

---

## 后端部署到阿里云的几种方式

### 方式一：阿里云 ECS（推荐，可控性高）

1. **买一台 ECS**（与 RDS、OSS 同地域，如华东1）。
2. **装 Node 18+**，拉代码，在项目根目录执行：
   ```bash
   cd Server/api
   npm ci
   npm run build
   ```
3. **配置环境变量**（与当前 Railway 一致，仅改数据库地址为阿里云 RDS）：
   - `DATABASE_URL`：阿里云 RDS 的地址（你已迁移好的）
   - `DB_SSL=false`（若 RDS 用内网/非 SSL）
   - `JWT_SECRET`、`OSS_*` 等照抄 Railway
4. **启动**：`PORT=4000 npm start`，或用 pm2：`pm2 start dist/main.js --name api`。
5. **安全组**：开放 80/443（若前面有 Nginx）或你用的端口；若直接暴露 Node，只开放一个端口即可。
6. **域名（可选）**：在 ECS 上绑域名，用 Nginx 做反向代理 + HTTPS（或用阿里云 SLB）。

前端（Vercel）环境变量里把 **NEXT_PUBLIC_API_BASE** 改为：`https://你的阿里云后端域名或IP:端口`（如 `https://api.你的域名.com`）。

---

### 方式二：阿里云 FC（函数计算，按量付费）

- 把 NestJS 打成**单函数**或 **HTTP 函数** 部署到 FC，入口为当前 `main.ts` 导出的 HTTP 服务。
- 配置同上的环境变量（DATABASE_URL 用阿里云 RDS、OSS 等）。
- 前端 **NEXT_PUBLIC_API_BASE** 指向 FC 提供的 HTTP 触发 URL。

适合流量不大、希望按量付费的场景；需要把应用适配成“无状态、冷启动可接受”的形式。

---

### 方式三：阿里云容器服务（ACK / 轻量 Kubernetes）

- 用现有 **Dockerfile** 构建镜像，推到阿里云 ACR，在 ACK 里部署 Deployment + Service。
- 环境变量通过 ConfigMap/Secret 或部署模板注入（同上：DATABASE_URL、JWT_SECRET、OSS_* 等）。
- 用 SLB/Ingress 暴露 HTTPS，前端 **NEXT_PUBLIC_API_BASE** 指到该地址。

适合已有容器化经验、希望和 RDS/OSS 同在一个云账号内统一管理的情况。

---

## 前端需要改什么？

只改**一处配置**，不再走 Railway：

1. **Vercel**：在项目环境变量里设置  
   `NEXT_PUBLIC_API_BASE = https://你的阿里云后端地址`  
   （不要再填 Railway 的地址。）
2. **本地开发**：`.env.local` 里同样把 `NEXT_PUBLIC_API_BASE` 改为阿里云后端地址（或本地 `http://localhost:4000`）。

代码里已经用 `NEXT_PUBLIC_API_BASE` 做代理/请求 base，无需改代码，只改环境变量即可“切掉” Railway。

---

## 小结

| 问题           | 原因                     | 做法                         |
|----------------|--------------------------|------------------------------|
| 延迟高         | 后端在 Railway，跨地域   | 把后端部署到阿里云（同地域） |
| 为什么还经 Railway | 之前后端只在 Railway 上跑 | 部署到阿里云后改 API 地址即可，不再经 Railway |
| 数据库/OSS     | 已在阿里云               | 保持不变，后端同地域直连     |

部署完成后：**用户 → 前端 → 阿里云后端 → 阿里云 RDS/OSS**，全程同地域，延迟会明显下降，上传也会更稳定。
